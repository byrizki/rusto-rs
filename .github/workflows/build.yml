name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build iOS XCFramework
  build-ios:
    name: Build RustO iOS XCFramework
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Add iOS targets
        run: |
          rustup target add aarch64-apple-ios
          rustup target add aarch64-apple-ios-sim
          rustup target add x86_64-apple-ios
      
      - name: Setup environment
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime-ios" >> $GITHUB_ENV
      
      - name: Build for iOS targets
        run: |
          cargo build --release --target aarch64-apple-ios --features ffi
          cargo build --release --target aarch64-apple-ios-sim --features ffi
          cargo build --release --target x86_64-apple-ios --features ffi
      
      - name: Create XCFramework
        run: |
          mkdir -p build/ios-device build/ios-simulator
          
          cp target/aarch64-apple-ios/release/librusto.a build/ios-device/
          
          lipo -create \
            target/aarch64-apple-ios-sim/release/librusto.a \
            target/x86_64-apple-ios/release/librusto.a \
            -output build/ios-simulator/librusto.a
          
          xcodebuild -create-xcframework \
            -library build/ios-device/librusto.a \
            -library build/ios-simulator/librusto.a \
            -output build/RustO.xcframework
          
          # Copy model files and dict files
          mkdir -p packages/ios/Resources/models
          cp -r models/mnn/*.mnn packages/ios/Resources/models/ || true
          cp -r models/mnn/*.txt packages/ios/Resources/models/ || true
          
          cd build
          zip -r RustO.xcframework.zip RustO.xcframework
          cd ..
          
          # Create a package with models
          mkdir -p build/package
          cp -r build/RustO.xcframework build/package/
          cp -r packages/ios/Resources build/package/
          cd build/package
          zip -r ../RustO-with-models.xcframework.zip .
          cd ../..
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-ios-xcframework
          path: |
            build/RustO.xcframework.zip
            build/RustO-with-models.xcframework.zip

  # Build Android AAR
  build-android:
    name: Build RustO Android AAR
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true
      
      - name: Build for Android targets
        run: |
          cargo build --release --target aarch64-linux-android --features ffi
          cargo build --release --target armv7-linux-androideabi --features ffi
          cargo build --release --target i686-linux-android --features ffi
          cargo build --release --target x86_64-linux-android --features ffi
          
          mkdir -p packages/android/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86,x86_64}
          cp target/aarch64-linux-android/release/librusto.so packages/android/src/main/jniLibs/arm64-v8a/
          cp target/armv7-linux-androideabi/release/librusto.so packages/android/src/main/jniLibs/armeabi-v7a/
          cp target/i686-linux-android/release/librusto.so packages/android/src/main/jniLibs/x86/
          cp target/x86_64-linux-android/release/librusto.so packages/android/src/main/jniLibs/x86_64/
          
          
          # Copy model files and dict files to assets
          mkdir -p packages/android/src/main/assets/models
          cp -r models/mnn/*.mnn packages/android/src/main/assets/models/ || true
          cp -r models/mnn/*.txt packages/android/src/main/assets/models/ || true
      
      - name: Make gradlew executable
        working-directory: packages/android
        run: chmod +x gradlew || true
      
      - name: Build AAR
        working-directory: packages/android
        run: |
          if [ -f "gradlew" ]; then
            ./gradlew assembleRelease
          else
            gradle assembleRelease
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-android-aar
          path: packages/android/build/outputs/aar/*.aar

  # Build .NET NuGet package
  build-dotnet:
    name: Build .NET NuGet - ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: linux
            arch: x64
            target: linux-x64
            runner: ubuntu-22.04
            lib: librusto.so
            rust_target: x86_64-unknown-linux-gnu
          - os: macos
            arch: x64
            target: osx-x64
            runner: macos-13
            lib: librusto.dylib
            rust_target: x86_64-apple-darwin
          - os: macos
            arch: arm64
            target: osx-arm64
            runner: macos-14
            lib: librusto.dylib
            rust_target: aarch64-apple-darwin
          - os: windows
            arch: x64
            target: win-x64
            runner: windows-2022
            lib: rusto.dll
            rust_target: x86_64-pc-windows-msvc
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}
      
      - name: Setup environment (Unix)
        if: matrix.os != 'windows'
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/onnxruntime/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/onnxruntime/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
      
      - name: Setup environment (Windows)
        if: matrix.os == 'windows'
        shell: bash
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_ENV
          echo "${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_PATH
      
      - name: Build native library
        run: cargo build --release --target ${{ matrix.rust_target }} --features ffi
      
      - name: Create runtimes directory
        shell: bash
        run: mkdir -p packages/dotnet/runtimes/${{ matrix.target }}/native
      
      - name: Copy library (Unix)
        if: matrix.os != 'windows'
        run: |
          cp target/${{ matrix.rust_target }}/release/${{ matrix.lib }} packages/dotnet/runtimes/${{ matrix.target }}/native/
      
      - name: Copy library (Windows)
        if: matrix.os == 'windows'
        shell: bash
        run: |
          cp target/${{ matrix.rust_target }}/release/${{ matrix.lib }} packages/dotnet/runtimes/${{ matrix.target }}/native/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-dotnet-${{ matrix.target }}
          path: packages/dotnet/runtimes/${{ matrix.target }}/**/*

  # Package .NET NuGet
  package-dotnet:
    name: Package .NET NuGet
    needs: [build-dotnet]
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Download all .NET artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rusto-dotnet-*
          path: artifacts
      
      - name: Merge runtime artifacts
        run: |
          mkdir -p packages/dotnet/runtimes
          for dir in artifacts/rusto-dotnet-*; do
            if [ -d "$dir/runtimes" ]; then
              cp -r "$dir/runtimes/"* packages/dotnet/runtimes/
            fi
          done
          
          # Copy model files and dict files
          mkdir -p packages/dotnet/models
          cp -r models/mnn/*.mnn packages/dotnet/models/ || true
          cp -r models/mnn/*.txt packages/dotnet/models/ || true
      
      - name: Pack NuGet package
        working-directory: packages/dotnet
        run: dotnet pack -c Release -o ../../nupkg || echo "NuGet pack will be done manually"
      
      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: rusto-dotnet-nupkg
          path: |
            nupkg/*.nupkg
            packages/dotnet/runtimes/**/*

  # Create GitHub Release
  release:
    name: Create GitHub Release
    needs: [build-ios, build-android, package-dotnet]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create release archives
        run: |
          mkdir -p releases
          cd artifacts
          
          for dir in rusto-x86_64-* rusto-aarch64-*; do
            if [ -d "$dir" ]; then
              cd "$dir"
              tar czf "../../releases/${dir}.tar.gz" *
              cd ..
            fi
          done
          
          if [ -d "rusto-ios-xcframework" ]; then
            cp rusto-ios-xcframework/RustO.xcframework.zip ../releases/ || true
            cp rusto-ios-xcframework/RustO-with-models.xcframework.zip ../releases/ || true
          fi
          
          if [ -d "rusto-android-aar" ]; then
            cp rusto-android-aar/*.aar ../releases/ || true
          fi
          
          if [ -d "rusto-dotnet-nupkg" ]; then
            cd rusto-dotnet-nupkg
            if ls *.nupkg 1> /dev/null 2>&1; then
              cp *.nupkg ../../releases/ || true
            fi
            if [ -d "runtimes" ]; then
              tar czf "../../releases/rusto-dotnet-runtimes.tar.gz" runtimes/
            fi
            cd ..
          fi
      
      - name: Generate checksums
        working-directory: releases
        run: |
          sha256sum * > SHA256SUMS || true
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## RustO! Release ${{ github.ref_name }}
            
            ### Highlights
            - Pure Rust OCR library powered by PaddleOCR models
            - Uses MNN inference engine for optimal performance
            - Cross-platform support (Linux, macOS, Windows, iOS, Android, .NET)
            - Includes bundled model files and dictionary files
            
            ### Platform Support
            - **Linux**: x64, ARM64
            - **macOS**: x64 (Intel), ARM64 (Apple Silicon)
            - **Windows**: x64
            - **iOS**: Universal XCFramework (device + simulator)
            - **Android**: AAR with all architectures (arm64-v8a, armeabi-v7a, x86, x86_64)
            - **.NET**: NuGet package with native libraries for all desktop platforms
            
            ### Installation
            Download the appropriate package for your platform and extract it.
            See SHA256SUMS for file verification.
            
            ### Inference Engine
            - Uses MNN (Mobile Neural Network) for efficient inference
            - Includes pre-converted PaddleOCR models in MNN format
            - Supports multiple languages via included dictionary files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
