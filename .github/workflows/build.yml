name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  ONNXRUNTIME_VERSION: 1.23.2

jobs:
  # Download prebuilt ONNX Runtime for desktop platforms
  download-onnxruntime-desktop:
    name: Download ONNX Runtime - ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - os: linux
            arch: x64
            onnx_file: onnxruntime-linux-x64-1.23.2.tgz
          - os: linux
            arch: arm64
            onnx_file: onnxruntime-linux-aarch64-1.23.2.tgz
          - os: macos
            arch: x64
            onnx_file: onnxruntime-osx-x86_64-1.23.2.tgz
          - os: macos
            arch: arm64
            onnx_file: onnxruntime-osx-arm64-1.23.2.tgz
          - os: windows
            arch: x64
            onnx_file: onnxruntime-win-x64-1.23.2.zip
    
    steps:
      - name: Download ONNX Runtime prebuilt
        run: |
          wget https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNXRUNTIME_VERSION }}/${{ matrix.onnx_file }}
          mkdir -p onnxruntime
          if [[ "${{ matrix.onnx_file }}" == *.zip ]]; then
            unzip ${{ matrix.onnx_file }} -d onnxruntime
          else
            tar -xzf ${{ matrix.onnx_file }} -C onnxruntime
          fi
          
          cd onnxruntime
          EXTRACTED_DIR=$(ls -d onnxruntime-* 2>/dev/null | head -n 1)
          if [ -d "$EXTRACTED_DIR" ]; then
            mv "$EXTRACTED_DIR"/* .
            rmdir "$EXTRACTED_DIR"
          fi
          ls -la
      
      - name: Upload ONNX Runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-${{ matrix.os }}-${{ matrix.arch }}
          path: onnxruntime/
          retention-days: 1

  # Build ONNX Runtime for iOS
  build-onnxruntime-ios:
    name: Build ONNX Runtime - iOS
    runs-on: macos-14
    
    steps:
      - name: Install dependencies
        run: |
          brew install cmake ninja
      
      - name: Checkout ONNX Runtime
        uses: actions/checkout@v4
        with:
          repository: microsoft/onnxruntime
          ref: v${{ env.ONNXRUNTIME_VERSION }}
          submodules: recursive
      
      - name: Build ONNX Runtime for iOS
        run: |
          python3 tools/ci_build/github/apple/build_ios_framework.py \
            --build_dir build_ios \
            --config Release \
            --parallel \
            --skip_tests \
            --build_apple_framework
          
          mkdir -p onnxruntime-ios
          cp -r build_ios/Release/onnxruntime.xcframework onnxruntime-ios/
      
      - name: Upload ONNX Runtime iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-ios
          path: onnxruntime-ios/
          retention-days: 1

  # Build ONNX Runtime for Android
  build-onnxruntime-android:
    name: Build ONNX Runtime - Android
    runs-on: ubuntu-22.04
    
    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3
      
      - name: Checkout ONNX Runtime
        uses: actions/checkout@v4
        with:
          repository: microsoft/onnxruntime
          ref: v${{ env.ONNXRUNTIME_VERSION }}
          submodules: recursive
      
      - name: Build ONNX Runtime for Android
        run: |
          export ANDROID_NDK=$ANDROID_NDK_HOME
          
          python3 tools/ci_build/github/android/build_aar_package.py \
            --build_dir build_android \
            --config Release \
            --android_sdk_path $ANDROID_HOME \
            --android_ndk_path $ANDROID_NDK \
            --parallel \
            --skip_tests
          
          mkdir -p onnxruntime-android
          cp -r build_android/aar_out/aar onnxruntime-android/ || cp -r build_android/*.aar onnxruntime-android/ || true
          
          mkdir -p onnxruntime-android/jni
          find build_android -name "*.so" -exec cp {} onnxruntime-android/jni/ \; || true
      
      - name: Upload ONNX Runtime Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-android
          path: onnxruntime-android/
          retention-days: 1

  # Build RustO library for desktop platforms
  build-rusto:
    name: Build RustO - ${{ matrix.target }}
    needs: [download-onnxruntime-desktop]
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: linux
            arch: x64
            target: x86_64-unknown-linux-gnu
            runner: ubuntu-22.04
            lib_ext: so
          - os: linux
            arch: arm64
            target: aarch64-unknown-linux-gnu
            runner: ubuntu-22.04
            lib_ext: so
          - os: macos
            arch: x64
            target: x86_64-apple-darwin
            runner: macos-13
            lib_ext: dylib
          - os: macos
            arch: arm64
            target: aarch64-apple-darwin
            runner: macos-14
            lib_ext: dylib
          - os: windows
            arch: x64
            target: x86_64-pc-windows-msvc
            runner: windows-2022
            lib_ext: dll
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download ONNX Runtime
        uses: actions/download-artifact@v4
        with:
          name: onnxruntime-${{ matrix.os }}-${{ matrix.arch }}
          path: onnxruntime
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Setup environment (Unix)
        if: matrix.os != 'windows'
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/onnxruntime/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/onnxruntime/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
      
      - name: Setup environment (Windows)
        if: matrix.os == 'windows'
        shell: bash
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_ENV
          echo "${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_PATH
      
      - name: Install Linux ARM64 cross-compile tools
        if: matrix.os == 'linux' && matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
      
      - name: Build RustO CLI
        run: |
          cargo build --release --target ${{ matrix.target }} --bin rusto
      
      - name: Build RustO library (with FFI)
        run: |
          cargo build --release --target ${{ matrix.target }} --features ffi
      
      - name: Strip binaries (Unix)
        if: matrix.os != 'windows'
        run: |
          strip target/${{ matrix.target }}/release/rusto || true
          strip target/${{ matrix.target }}/release/librusto.${{ matrix.lib_ext }} || true
      
      - name: Package RustO
        shell: bash
        run: |
          mkdir -p package/bin package/lib package/include
          
          if [ "${{ matrix.os }}" = "windows" ]; then
            cp target/${{ matrix.target }}/release/rusto.exe package/bin/
          else
            cp target/${{ matrix.target }}/release/rusto package/bin/
          fi
          
          if [ "${{ matrix.os }}" = "windows" ]; then
            cp target/${{ matrix.target }}/release/rusto.dll package/lib/
            cp target/${{ matrix.target }}/release/rusto.dll.lib package/lib/ || true
          else
            cp target/${{ matrix.target }}/release/librusto.${{ matrix.lib_ext }} package/lib/
          fi
          
          cp -r onnxruntime/lib/* package/lib/ || true
          
          cp packages/dotnet/RustO.cs package/include/ || true
          
          cat > package/README.md << 'EOF'
          # RustO! - Pure Rust OCR Library
          
          High-performance OCR library powered by PaddleOCR models with ONNX Runtime.
          
          ## Contents
          
          - `bin/rusto` - CLI executable
          - `lib/` - Shared libraries (RustO + ONNX Runtime)
          - `include/` - C# bindings (if applicable)
          
          ## Quick Start
          
          ```bash
          ./bin/rusto --det-model det.onnx --rec-model rec.onnx --dict dict.txt image.jpg
          ```
          
          For more information: https://github.com/yourusername/rusto-rs
          EOF
      
      - name: Upload RustO artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-${{ matrix.target }}
          path: package/

  # Build iOS XCFramework
  build-ios:
    name: Build RustO iOS XCFramework
    needs: [build-onnxruntime-ios]
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download ONNX Runtime iOS
        uses: actions/download-artifact@v4
        with:
          name: onnxruntime-ios
          path: onnxruntime-ios
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Add iOS targets
        run: |
          rustup target add aarch64-apple-ios
          rustup target add aarch64-apple-ios-sim
          rustup target add x86_64-apple-ios
      
      - name: Setup environment
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime-ios" >> $GITHUB_ENV
      
      - name: Build for iOS targets
        run: |
          cargo build --release --target aarch64-apple-ios --features ffi
          cargo build --release --target aarch64-apple-ios-sim --features ffi
          cargo build --release --target x86_64-apple-ios --features ffi
      
      - name: Create XCFramework
        run: |
          mkdir -p build/ios-device build/ios-simulator
          
          cp target/aarch64-apple-ios/release/librusto.a build/ios-device/
          
          lipo -create \
            target/aarch64-apple-ios-sim/release/librusto.a \
            target/x86_64-apple-ios/release/librusto.a \
            -output build/ios-simulator/librusto.a
          
          xcodebuild -create-xcframework \
            -library build/ios-device/librusto.a \
            -library build/ios-simulator/librusto.a \
            -output build/RustO.xcframework
          
          cd build
          zip -r RustO.xcframework.zip RustO.xcframework
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-ios-xcframework
          path: build/RustO.xcframework.zip

  # Build Android AAR
  build-android:
    name: Build RustO Android AAR
    needs: [build-onnxruntime-android]
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download ONNX Runtime Android
        uses: actions/download-artifact@v4
        with:
          name: onnxruntime-android
          path: onnxruntime-android
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true
      
      - name: Setup environment
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime-android" >> $GITHUB_ENV
      
      - name: Build for Android targets
        run: |
          cargo build --release --target aarch64-linux-android --features ffi
          cargo build --release --target armv7-linux-androideabi --features ffi
          cargo build --release --target i686-linux-android --features ffi
          cargo build --release --target x86_64-linux-android --features ffi
          
          mkdir -p packages/android/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86,x86_64}
          cp target/aarch64-linux-android/release/librusto.so packages/android/src/main/jniLibs/arm64-v8a/
          cp target/armv7-linux-androideabi/release/librusto.so packages/android/src/main/jniLibs/armeabi-v7a/
          cp target/i686-linux-android/release/librusto.so packages/android/src/main/jniLibs/x86/
          cp target/x86_64-linux-android/release/librusto.so packages/android/src/main/jniLibs/x86_64/
          
          if [ -d "onnxruntime-android/jni" ]; then
            find onnxruntime-android/jni -name "*.so" -exec cp {} packages/android/src/main/jniLibs/arm64-v8a/ \; || true
            find onnxruntime-android/jni -name "*.so" -exec cp {} packages/android/src/main/jniLibs/armeabi-v7a/ \; || true
            find onnxruntime-android/jni -name "*.so" -exec cp {} packages/android/src/main/jniLibs/x86/ \; || true
            find onnxruntime-android/jni -name "*.so" -exec cp {} packages/android/src/main/jniLibs/x86_64/ \; || true
          fi
      
      - name: Make gradlew executable
        working-directory: packages/android
        run: chmod +x gradlew || true
      
      - name: Build AAR
        working-directory: packages/android
        run: |
          if [ -f "gradlew" ]; then
            ./gradlew assembleRelease
          else
            gradle assembleRelease
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-android-aar
          path: packages/android/build/outputs/aar/*.aar

  # Build .NET NuGet package
  build-dotnet:
    name: Build .NET NuGet - ${{ matrix.target }}
    needs: [download-onnxruntime-desktop]
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: linux
            arch: x64
            target: linux-x64
            runner: ubuntu-22.04
            lib: librusto.so
            rust_target: x86_64-unknown-linux-gnu
          - os: macos
            arch: x64
            target: osx-x64
            runner: macos-13
            lib: librusto.dylib
            rust_target: x86_64-apple-darwin
          - os: macos
            arch: arm64
            target: osx-arm64
            runner: macos-14
            lib: librusto.dylib
            rust_target: aarch64-apple-darwin
          - os: windows
            arch: x64
            target: win-x64
            runner: windows-2022
            lib: rusto.dll
            rust_target: x86_64-pc-windows-msvc
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download ONNX Runtime
        uses: actions/download-artifact@v4
        with:
          name: onnxruntime-${{ matrix.os }}-${{ matrix.arch }}
          path: onnxruntime
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}
      
      - name: Setup environment (Unix)
        if: matrix.os != 'windows'
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/onnxruntime/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/onnxruntime/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
      
      - name: Setup environment (Windows)
        if: matrix.os == 'windows'
        shell: bash
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_ENV
          echo "${{ github.workspace }}/onnxruntime/lib" >> $GITHUB_PATH
      
      - name: Build native library
        run: cargo build --release --target ${{ matrix.rust_target }} --features ffi
      
      - name: Create runtimes directory
        shell: bash
        run: mkdir -p packages/dotnet/runtimes/${{ matrix.target }}/native
      
      - name: Copy library (Unix)
        if: matrix.os != 'windows'
        run: |
          cp target/${{ matrix.rust_target }}/release/${{ matrix.lib }} packages/dotnet/runtimes/${{ matrix.target }}/native/
          cp -r onnxruntime/lib/* packages/dotnet/runtimes/${{ matrix.target }}/native/ || true
      
      - name: Copy library (Windows)
        if: matrix.os == 'windows'
        shell: bash
        run: |
          cp target/${{ matrix.rust_target }}/release/${{ matrix.lib }} packages/dotnet/runtimes/${{ matrix.target }}/native/
          cp target/${{ matrix.rust_target }}/release/rusto.dll.lib packages/dotnet/runtimes/${{ matrix.target }}/native/ || true
          cp -r onnxruntime/lib/* packages/dotnet/runtimes/${{ matrix.target }}/native/ || true
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-dotnet-${{ matrix.target }}
          path: packages/dotnet/runtimes/${{ matrix.target }}/**/*

  # Package .NET NuGet
  package-dotnet:
    name: Package .NET NuGet
    needs: [build-dotnet]
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Download all .NET artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rusto-dotnet-*
          path: artifacts
      
      - name: Merge runtime artifacts
        run: |
          mkdir -p packages/dotnet/runtimes
          for dir in artifacts/rusto-dotnet-*; do
            if [ -d "$dir/runtimes" ]; then
              cp -r "$dir/runtimes/"* packages/dotnet/runtimes/
            fi
          done
      
      - name: Pack NuGet package
        working-directory: packages/dotnet
        run: dotnet pack -c Release -o ../../nupkg || echo "NuGet pack will be done manually"
      
      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: rusto-dotnet-nupkg
          path: |
            nupkg/*.nupkg
            packages/dotnet/runtimes/**/*

  # Create GitHub Release
  release:
    name: Create GitHub Release
    needs: [build-rusto, build-ios, build-android, package-dotnet]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create release archives
        run: |
          mkdir -p releases
          cd artifacts
          
          for dir in rusto-x86_64-* rusto-aarch64-*; do
            if [ -d "$dir" ]; then
              cd "$dir"
              tar czf "../../releases/${dir}.tar.gz" *
              cd ..
            fi
          done
          
          if [ -d "rusto-ios-xcframework" ]; then
            cp rusto-ios-xcframework/RustO.xcframework.zip ../releases/
          fi
          
          if [ -d "rusto-android-aar" ]; then
            cp rusto-android-aar/*.aar ../releases/ || true
          fi
          
          if [ -d "rusto-dotnet-nupkg" ]; then
            cd rusto-dotnet-nupkg
            if ls *.nupkg 1> /dev/null 2>&1; then
              cp *.nupkg ../../releases/ || true
            fi
            if [ -d "runtimes" ]; then
              tar czf "../../releases/rusto-dotnet-runtimes.tar.gz" runtimes/
            fi
            cd ..
          fi
      
      - name: Generate checksums
        working-directory: releases
        run: |
          sha256sum * > SHA256SUMS || true
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## RustO! Release ${{ github.ref_name }}
            
            ### Highlights
            - Built with ONNX Runtime ${{ env.ONNXRUNTIME_VERSION }}
            - Pure Rust OCR library powered by PaddleOCR models
            - Cross-platform support (Linux, macOS, Windows, iOS, Android, .NET)
            
            ### Platform Support
            - **Linux**: x64, ARM64
            - **macOS**: x64 (Intel), ARM64 (Apple Silicon)
            - **Windows**: x64
            - **iOS**: Universal XCFramework (device + simulator)
            - **Android**: AAR with all architectures (arm64-v8a, armeabi-v7a, x86, x86_64)
            - **.NET**: NuGet package with native libraries for all desktop platforms
            
            ### Installation
            Download the appropriate package for your platform and extract it.
            See SHA256SUMS for file verification.
            
            ### ONNX Runtime
            - Desktop platforms use prebuilt ONNX Runtime v${{ env.ONNXRUNTIME_VERSION }}
            - Mobile platforms (iOS/Android) include ONNX Runtime built from source
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
