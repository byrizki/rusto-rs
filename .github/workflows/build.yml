name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build Rust CLI binaries for all platforms
  build-cli:
    name: Build CLI - ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: rusto
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: rusto
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: rusto
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: rusto.exe
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Strip binary (Unix)
        if: runner.os != 'Windows'
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.artifact }}

  # Build iOS XCFramework
  build-ios:
    name: Build iOS XCFramework
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Add iOS targets
        run: |
          rustup target add aarch64-apple-ios
          rustup target add aarch64-apple-ios-sim
          rustup target add x86_64-apple-ios
      
      - name: Build for all iOS targets
        run: |
          cargo build --release --target aarch64-apple-ios --features ffi
          cargo build --release --target aarch64-apple-ios-sim --features ffi
          cargo build --release --target x86_64-apple-ios --features ffi
      
      - name: Create XCFramework
        run: |
          mkdir -p build/ios-device
          mkdir -p build/ios-simulator
          
          # Copy device library
          cp target/aarch64-apple-ios/release/librusto.a build/ios-device/
          
          # Create simulator fat library
          lipo -create \
            target/aarch64-apple-ios-sim/release/librusto.a \
            target/x86_64-apple-ios/release/librusto.a \
            -output build/ios-simulator/librusto.a
          
          # Create XCFramework
          xcodebuild -create-xcframework \
            -library build/ios-device/librusto.a \
            -library build/ios-simulator/librusto.a \
            -output build/RustO.xcframework
          
          cd build
          zip -r RustO.xcframework.zip RustO.xcframework
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-ios-xcframework
          path: build/RustO.xcframework.zip

  # Build Android AAR (all architectures)
  build-android:
    name: Build Android AAR
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Build for all Android targets
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          # Build for each architecture
          cargo build --release --target aarch64-linux-android --features ffi
          cargo build --release --target armv7-linux-androideabi --features ffi
          cargo build --release --target i686-linux-android --features ffi
          cargo build --release --target x86_64-linux-android --features ffi
          
          # Copy to jniLibs
          mkdir -p packages/android/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86,x86_64}
          cp target/aarch64-linux-android/release/librusto.so packages/android/src/main/jniLibs/arm64-v8a/
          cp target/armv7-linux-androideabi/release/librusto.so packages/android/src/main/jniLibs/armeabi-v7a/
          cp target/i686-linux-android/release/librusto.so packages/android/src/main/jniLibs/x86/
          cp target/x86_64-linux-android/release/librusto.so packages/android/src/main/jniLibs/x86_64/
      
      - name: Build AAR
        working-directory: packages/android
        run: ./gradlew assembleRelease
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-android-aar
          path: packages/android/build/outputs/aar/*.aar

  # Build .NET NuGet package
  build-dotnet:
    name: Build .NET NuGet
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            lib: librusto.so
          - os: macos-latest
            target: osx-x64
            lib: librusto.dylib
          - os: macos-latest
            target: osx-arm64
            lib: librusto.dylib
          - os: windows-latest
            target: win-x64
            lib: rusto.dll
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build native library
        run: cargo build --release --features ffi
      
      - name: Create runtimes directory
        run: mkdir -p packages/dotnet/runtimes/${{ matrix.target }}/native
      
      - name: Copy library
        run: cp target/release/${{ matrix.lib }} packages/dotnet/runtimes/${{ matrix.target }}/native/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusto-dotnet-${{ matrix.target }}
          path: packages/dotnet/runtimes/${{ matrix.target }}/**/*

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [build-cli, build-ios, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create release archives
        run: |
          mkdir -p releases
          cd artifacts
          
          # Package CLI binaries
          for dir in rusto-*-*-*; do
            if [ -d "$dir" ]; then
              cd "$dir"
              tar czf "../../releases/${dir}.tar.gz" *
              cd ..
            fi
          done
          
          # Copy XCFramework
          if [ -d "rusto-ios-xcframework" ]; then
            cp rusto-ios-xcframework/RustO.xcframework.zip ../releases/
          fi
          
          # Copy AAR
          if [ -d "rusto-android-aar" ]; then
            cp rusto-android-aar/*.aar ../releases/
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: releases/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
