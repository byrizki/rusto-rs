name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        default: '0.1.0'

jobs:
  # Publish to crates.io
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true

  # Publish to NuGet
  publish-nuget:
    name: Publish to NuGet
    runs-on: ubuntu-latest
    needs: [publish-crates]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Download runtime artifacts from release
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          
          # Download native libraries from GitHub release
          gh release download "v${VERSION}" -p "rusto-dotnet-*" -D packages/dotnet/runtimes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build NuGet package
        working-directory: packages/dotnet
        run: dotnet pack -c Release
      
      - name: Publish to NuGet
        working-directory: packages/dotnet
        run: dotnet nuget push "bin/Release/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
        continue-on-error: true

  # Publish to CocoaPods
  publish-cocoapods:
    name: Publish to CocoaPods
    runs-on: macos-latest
    needs: [publish-crates]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup CocoaPods
        run: gem install cocoapods
      
      - name: Validate Pod spec
        working-directory: packages/ios
        run: pod spec lint RustO.podspec --allow-warnings
      
      - name: Publish to CocoaPods
        working-directory: packages/ios
        run: pod trunk push RustO.podspec --allow-warnings
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        continue-on-error: true

  # Publish Android AAR to Maven Central (optional - requires setup)
  publish-maven:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    needs: [publish-crates]
    if: false  # Enable when Maven Central is configured
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download AAR from release
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"
          gh release download "v${VERSION}" -p "*.aar" -D packages/android/build/outputs/aar
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish to Maven Central
        working-directory: packages/android
        run: ./gradlew publishReleasePublicationToMavenRepository
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
